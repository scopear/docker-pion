version: 2.1
jobs:
  build:
    docker:
      - image: scopear/docker-base:ci-alpine3.12
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    steps:
      - setup_remote_docker:   
          version: 19.03.13
      - checkout
      - run:
          name: Docker Login
          command: docker_login
      - run:
          name: Build Images
          command: docker build -t "scopear/docker-pion" .
      - run:
          name: Push Images
          command: |
            DOCKER_IMAGE="scopear/docker-pion"
            [[ -z "${CIRCLE_TAG}" ]] && IMAGE_NAME="git-$CIRCLE_SHA1" || IMAGE_NAME="${CIRCLE_TAG}"
            echo "Pushing $DOCKER_IMAGE:$IMAGE_NAME ..."
            docker tag "$DOCKER_IMAGE" "$DOCKER_IMAGE:$IMAGE_NAME"
            docker push "$DOCKER_IMAGE:$IMAGE_NAME"
      - run:
          name: Create Image Artifact
          command: docker save -o docker-pion.tar scopear/docker-pion
      - store_artifacts:
          path: docker-pion.tar
          destination: docker-pion.tar
      - run:
          name: Save Image Digest env variable
          command: |
            IMAGE="scopear/docker-pion"
            mkdir -p /tmp/workspace/shared-envs
            IMAGE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${IMAGE}" | sed 's/\(.*\)@\(.*\)/\2/g')
            echo "export IMAGE_DIGEST=${IMAGE_DIGEST}" >> /tmp/workspace/shared-envs/build-envs
      - persist_to_workspace:
          root: /tmp/workspace
          paths: 
          - shared-envs/*

  on-prem-upload-image-to-s3:
    docker:
      - image: scopear/docker-base:ci-aws-alpine3.12
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    steps:
      - setup_remote_docker:   
          version: 19.03.13
      - run:
          name: Docker Login
          command: docker_login
      - run:
          name: Upload Image
          command: docker_upload_s3 "scopear/docker-pion" "$CIRCLE_TAG"

  aqua-scan:
    docker:
      - image: scopear/docker-base:ci-aws-alpine3.12
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    working_directory: /tmp
    steps:
      - setup_remote_docker:
          version: 19.03.13
      - run:
          name: Docker Login
          command: docker_login
      - run:
          name: Run AquaScan Image
          command: >-
            DOCKER_IMAGE="scopear/docker-pion";
            [[ -z "${CIRCLE_TAG}" ]] && IMAGE_NAME="git-$CIRCLE_SHA1" || IMAGE_NAME="${CIRCLE_TAG}";
            echo "Running Aqua Scanner Image tagged $AQUA_SCANNER_VERSION...";
            echo "Scanning $DOCKER_IMAGE:$IMAGE_NAME ...";
            docker run --rm -v /tmp:/tmp -v /var/run/docker.sock:/var/run/docker.sock
            $AQUA_SCANNER_REPO:$AQUA_SCANNER_VERSION
            scan --registry "$IMAGE_REGISTRY" "$DOCKER_IMAGE:$IMAGE_NAME"
            --host $AQUA_HOST --user $AQUA_CONSOLE_USER --password $AQUA_CONSOLE_PASS
            --show-negligible --register
            --htmlfile /tmp/out.html --jsonfile /tmp/out.json --html
            > /tmp/out.html;
      - store_artifacts:
          path: /tmp/out.html
          destination: aquascan_pion_results.html

workflows:
  version: 2
  deploy:
    jobs:
      - build:
          context: scope-circleci
          filters:
            branches:
              only:
                - /develop/
            tags:
              only:
                - /^\d+\.\d+\.\d+.*/
                - /^on-prem-\d+\.\d+\.\d+.*/
                
      - on-prem-upload-image-to-s3:
          requires:
           - build
          context: scope-circleci-on-prem
          filters:
            branches:
              ignore:
                - /.*/
            tags:
              only:
                - /^on-prem-\d+\.\d+\.\d+.*$/
      
      - aqua-scan:
          requires:
           - build
          context: scope-aqua-scan
          filters:
            branches:
              only:
                - /.*/
            tags:
              only:
                - /.*/
  
  weekly:
    triggers:
      - schedule:
          cron: "0 0 * * 1"
          filters:
            branches:
              only:
                - /develop/
    jobs:
      - build:
          context: scope-circleci
